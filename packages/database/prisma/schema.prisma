generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Tier {
  S
  A
  B
  C
  D
  E
}

enum MarketStatus {
  OPEN
  CLOSED
  RESOLVED
}

enum TradeSide {
  BUY
  SELL
}

model Trader {
  id              String    @id @default(uuid())
  address         String    @unique
  displayName     String?
  profilePicture  String?   // Profile picture URL
  twitterUsername String?   // Twitter/X username (from xUsername field)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Tier and scoring
  tier            Tier      @default(E)
  rarityScore     Int       @default(0)
  
  // PnL metrics
  realizedPnl     Decimal   @default(0) @db.Decimal(20, 8)
  unrealizedPnl   Decimal   @default(0) @db.Decimal(20, 8)
  totalPnl        Decimal   @default(0) @db.Decimal(20, 8)
  
  // Performance metrics
  winRate         Float     @default(0)
  profitFactor    Float     @default(0)
  maxDrawdown     Float     @default(0)
  tradeCount      Int       @default(0)
  
  // Geolocation (for map visualization)
  latitude        Float?
  longitude       Float?
  country         String?
  
  lastActiveAt    DateTime?
  tags            String[]  @default([])
  
  // Relations
  trades          Trade[]
  positions       PositionSnapshot[]
  
  @@index([tier, rarityScore])
  @@index([totalPnl])
  @@index([lastActiveAt])
  @@index([country])
}

model Market {
  id              String        @id
  question        String
  category        String?
  eventSlug       String?       // Polymarket parent event slug for URL
  slug            String?       // Market slug
  endDate         DateTime?
  liquidity       Decimal?      @db.Decimal(20, 8)
  volume          Decimal?      @db.Decimal(20, 8)
  status          MarketStatus  @default(OPEN)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  trades          Trade[]
  positions       PositionSnapshot[]
  smartStats      MarketSmartStats[]
  
  @@index([status, category])
  @@index([endDate])
}

model Trade {
  id              String      @id
  traderId        String
  marketId        String
  outcome         String
  side            TradeSide
  size            Decimal     @db.Decimal(20, 8)
  price           Decimal     @db.Decimal(10, 8)
  timestamp       DateTime
  raw             Json?
  
  createdAt       DateTime    @default(now())
  
  // Relations
  trader          Trader      @relation(fields: [traderId], references: [id])
  market          Market      @relation(fields: [marketId], references: [id])
  
  @@index([traderId, timestamp])
  @@index([marketId, timestamp])
  @@index([timestamp])
}

model PositionSnapshot {
  id              String      @id @default(uuid())
  traderId        String
  marketId        String
  shares          Decimal     @db.Decimal(20, 8)
  avgPrice        Decimal     @db.Decimal(10, 8)
  pnlEst          Decimal     @db.Decimal(20, 8)
  timestamp       DateTime
  
  createdAt       DateTime    @default(now())
  
  // Relations
  trader          Trader      @relation(fields: [traderId], references: [id])
  market          Market      @relation(fields: [marketId], references: [id])
  
  @@index([traderId, marketId, timestamp])
  @@index([timestamp])
}

model MarketSmartStats {
  id              String      @id @default(uuid())
  marketId        String
  computedAt      DateTime    @default(now())
  
  smartCount      Int         @default(0)
  smartWeighted   Decimal     @default(0) @db.Decimal(20, 8)
  smartShare      Float       @default(0)
  smartScore      Decimal     @default(0) @db.Decimal(20, 8)
  topSmartTraders Json?
  
  // Pinned markets (top-5 feature)
  isPinned        Boolean     @default(false)
  priority        Int         @default(0)        // 1-5 for top-5, 0 for dynamic
  pinnedAt        DateTime?
  lastChecked     DateTime?                     // Last verification time
  
  // Relations
  market          Market      @relation(fields: [marketId], references: [id])
  
  @@index([marketId, computedAt])
  @@index([smartScore])
  @@index([isPinned, priority])
}

model MultiOutcomePosition {
  id              String      @id @default(uuid())
  
  // Event & Market info
  eventSlug       String      // Parent event (e.g., "who-will-trump-nominate-as-fed-chair")
  marketId        String      // Specific outcome market ID
  outcomeTitle    String      // e.g., "Kevin Warsh"
  currentPrice    Float       // Current odds (0-1)
  
  // Smart trader positions
  traderAddress   String
  traderName      String?
  traderTier      Tier
  position        String      // "YES" or "NO"
  shares          Decimal     @db.Decimal(20, 8)
  entryPrice      Float
  
  computedAt      DateTime    @default(now())
  
  @@index([eventSlug, computedAt])
  @@index([marketId])
  @@index([traderTier])
}

model IngestionState {
  id              String      @id @default(uuid())
  source          String
  key             String
  cursor          String?
  lastTimestamp   DateTime?
  updatedAt       DateTime    @updatedAt
  
  @@unique([source, key])
  @@index([source])
}

model TelegramAlert {
  id              String      @id @default(uuid())
  
  // Alert type
  type            String      // "whale" | "price_move"
  severity        String      @default("medium") // "high" | "medium" | "low"
  
  // Market info
  marketTitle     String
  marketSlug      String?
  outcome         String?
  
  // Price data (for price_move alerts)
  priceOld        Float?
  priceNew        Float?
  price           Float?      // Current price (for whale alerts)
  percentChange   Float?
  durationSec     Int?
  direction       String?     // "UP" | "DOWN"
  
  // Whale data (for whale alerts)
  sizeUsd         Float?
  wallet          String?
  
  // Timestamps
  alertTimestamp  DateTime    // When alert was triggered
  createdAt       DateTime    @default(now())
  
  @@index([type, alertTimestamp])
  @@index([alertTimestamp])
  @@index([marketSlug])
}

